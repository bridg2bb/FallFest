
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
    }

    .container {
        max-width: 1200px;
    }

    .table-container {
        overflow-x: auto;
    }

    th, td {
        white-space: nowrap;
    }

    /* Modal specific styles */
    .modal {
        background-color: rgba(0, 0, 0, 0.5);
    }
</style>
<div class="container mx-auto bg-white rounded-xl shadow-xl p-6 md:p-8">

    <!-- Order Items Table -->
    <div class="mt-8">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">Item Totals</h1>
        <div class="relative bg-gray-50 rounded-lg overflow-hidden shadow-sm border border-gray-200">
            <!-- Loading Panel for Item Totals -->
            <div id="itemTotalsLoadingPanel" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10 hidden">
                <div class="flex flex-col items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 text-3xl"></i>
                    <span class="mt-2 text-blue-600 font-medium">Loading item totals...</span>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Item Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Quantity Sold
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Total Revenue
                            </th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Item totals will be inserted here by JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-100 font-bold text-gray-800">
                            <td class="px-6 py-4 text-sm">Totals</td>
                            <td class="px-6 py-4 text-sm" id="totalQuantitySold"></td>
                            <td class="px-6 py-4 text-sm" id="totalRevenue"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-8">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">All Sales</h1>

        <!-- Filter and Sort Controls -->
        <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0 md:space-x-4">
            <!-- Search Bar -->
            <div class="w-full md:w-auto flex-grow">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search orders..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Sort Dropdown -->
            <div class="w-full md:w-auto">
                <select id="sortSelect" class="w-full py-2 px-4 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    <option value="TransactionDateTimeDesc">Date (Newest First)</option>
                    <option value="TransactionDateTimeAsc">Date (Oldest First)</option>
                    <option value="AmountPaidDesc">Amount Paid (High to Low)</option>
                    <option value="AmountPaidAsc">Amount Paid (Low to High)</option>
                </select>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="relative bg-gray-50 rounded-lg overflow-hidden shadow-sm border border-gray-200">
            <!-- Loading Panel for Orders -->
            <div id="ordersLoadingPanel" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10 hidden">
                <div class="flex flex-col items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 text-3xl"></i>
                    <span class="mt-2 text-blue-600 font-medium">Loading orders...</span>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Order ID
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Transaction Date
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Amount Paid
                            </th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Totals Summary -->
            <div class="flex flex-col md:flex-row justify-end mt-6 space-y-4 md:space-y-0 md:space-x-8 text-lg font-bold">
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm">
                    Total Orders: <span id="totalOrders" class="text-blue-600">0</span>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm">
                    Total Amount Paid: <span id="totalAmountPaid" class="text-blue-600">$0.00</span>
                </div>
            </div>

            <!-- No Orders Message -->
            <div id="noOrdersMessage" class="hidden text-center text-gray-500 mt-6 p-4 border border-dashed border-gray-300 rounded-lg">
                No orders found matching the current criteria.
            </div>
        </div>
    </div>
</div>

<!-- Order Items Modal -->
<div id="orderDetailsModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0 duration-300 ease-out" id="modalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Order Details</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="modalBody" class="space-y-4">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
    // Use a self-invoking function to avoid global variables
    (function () {
        // This will hold the orders data once fetched from the API
        let allOrders = [];

        const ordersTableBody = document.getElementById('ordersTableBody');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const noOrdersMessage = document.getElementById('noOrdersMessage');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalBody = document.getElementById('modalBody');
        const totalOrdersSpan = document.getElementById('totalOrders');
        const totalAmountPaidSpan = document.getElementById('totalAmountPaid');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const totalQuantitySoldSpan = document.getElementById('totalQuantitySold');
        const totalRevenueSpan = document.getElementById('totalRevenue');

        // Get references to the new loading panels
        const ordersLoadingPanel = document.getElementById('ordersLoadingPanel');
        const itemTotalsLoadingPanel = document.getElementById('itemTotalsLoadingPanel');

        // Function to fetch and render the main orders table from the API
        async function fetchAndRenderOrders() {
            ordersLoadingPanel.classList.remove('hidden'); // Show loading panel
            try {
                const response = await fetch('/Tickets/GetOrders');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                allOrders = await response.json();
                filterAndSortData(); // Render the table with the fetched data
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Failed to load orders. Please try again.</td></tr>`;
                totalOrdersSpan.textContent = '0';
                totalAmountPaidSpan.textContent = '$0.00';
            } finally {
                ordersLoadingPanel.classList.add('hidden'); // Hide loading panel
            }
        }

        // Function to render the table rows based on filtered and sorted data
        function renderTable(data) {
            ordersTableBody.innerHTML = '';
            if (data.length === 0) {
                noOrdersMessage.classList.remove('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                data.forEach(order => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors duration-200 cursor-pointer';
                    const formattedDate = new Date(order.transactionDateTime).toLocaleString();

                    row.innerHTML = `
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.orderId.substring(0, 8)}...</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${order.amountPaid.toFixed(2)}</td>
                                    `;

                    // Add a click listener to the row to show the details modal
                    row.addEventListener('click', () => showOrderDetails(order));
                    ordersTableBody.appendChild(row);
                });
            }
        }

        // New function to fetch and render the item totals from the API
        async function fetchAndRenderItemTotals() {
            itemTotalsLoadingPanel.classList.remove('hidden'); // Show loading panel
            try {
                const response = await fetch('/Tickets/GetItemTotals');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const itemTotals = await response.json();
                renderItemTotals(itemTotals);
            } catch (error) {
                console.error('Error fetching item totals:', error);
                itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Failed to load item totals.</td></tr>`;
                totalQuantitySoldSpan.textContent = '';
                totalRevenueSpan.textContent = '';
            } finally {
                itemTotalsLoadingPanel.classList.add('hidden'); // Hide loading panel
            }
        }

        // Function to render the item totals table from fetched data
        function renderItemTotals(data) {
            itemsTableBody.innerHTML = '';
            let grandTotalQuantity = 0;
            let grandTotalRevenue = 0;

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                row.innerHTML = `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.itemName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantitySold}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.totalRevenue.toFixed(2)}</td>
                                `;
                itemsTableBody.appendChild(row);
                grandTotalQuantity += item.quantitySold;
                grandTotalRevenue += item.totalRevenue;
            });

            // Update the totals in the footer
            totalQuantitySoldSpan.textContent = grandTotalQuantity;
            totalRevenueSpan.textContent = `$${grandTotalRevenue.toFixed(2)}`;
        }

        // Function to show order details in the modal
        function showOrderDetails(order) {
            const formattedDate = new Date(order.transactionDateTime).toLocaleString();
            modalBody.innerHTML = `
                                <p><strong>Order ID:</strong> ${order.orderId}</p>
                                <p><strong>Transaction Date:</strong> ${formattedDate}</p>
                                <p><strong>Amount Paid:</strong> $${order.amountPaid.toFixed(2)}</p>
                                <p><strong>Order Type:</strong> Tickets</p>
                                <h3 class="font-bold text-lg mt-4 mb-2">Items</h3>
                                <ul class="list-disc list-inside space-y-2">
                                    ${order.orderItems.map(item => `
                                        <li class="flex justify-between items-center text-gray-700">
                                            <span>${item.quantity} x ${item.itemName}</span>
                                            <span>$${(item.quantity * item.unitPrice).toFixed(2)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            `;

            // Show the modal
            orderDetailsModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Function to close the modal
        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                orderDetailsModal.classList.add('hidden');
            }, 300);
        }

        // Function to filter and sort the data
        function filterAndSortData() {
            let filteredData = [...allOrders];
            const searchTerm = searchInput.value.toLowerCase();
            const sortType = sortSelect.value;

            // Filter by search term
            if (searchTerm) {
                filteredData = filteredData.filter(order =>
                    order.orderId.toLowerCase().includes(searchTerm) ||
                    order.amountPaid.toFixed(2).includes(searchTerm)
                );
            }

            // Sort the data
            filteredData.sort((a, b) => {
                switch (sortType) {
                    case 'TransactionDateTimeAsc':
                        return new Date(a.transactionDateTime) - new Date(b.transactionDateTime);
                    case 'TransactionDateTimeDesc':
                        return new Date(b.transactionDateTime) - new Date(a.transactionDateTime);
                    case 'AmountPaidAsc':
                        return a.amountPaid - b.amountPaid;
                    case 'AmountPaidDesc':
                        return b.amountPaid - a.amountPaid;
                    default:
                        return 0;
                }
            });

            // Calculate totals for the filtered data
            const totalOrders = filteredData.length;
            const totalAmountPaid = filteredData.reduce((sum, order) => sum + order.amountPaid, 0);

            // Update the totals in the summary div
            totalOrdersSpan.textContent = totalOrders;
            totalAmountPaidSpan.textContent = `$${totalAmountPaid.toFixed(2)}`;

            renderTable(filteredData);
        }

        // Add event listeners for controls
        searchInput.addEventListener('input', filterAndSortData);
        sortSelect.addEventListener('change', filterAndSortData);
        closeModalBtn.addEventListener('click', closeModal);
        // Close modal when clicking outside of it
        orderDetailsModal.addEventListener('click', (event) => {
            if (event.target === orderDetailsModal) {
                closeModal();
            }
        });

        // Initial render
        window.onload = function () {
            fetchAndRenderOrders();
            fetchAndRenderItemTotals();
        };

    })();
</script>
